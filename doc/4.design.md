# Дизайн

Система реализована как двухуровневое Web-приложение:

* пользовательский интерфейс в виде Web-страницы;
* сервер, предоставляющий RESTful API для загрузки изображений и запросов к ним.

Так как обработка изображения моделью распознавания может требовать значительных вычислительных ресурсов, она выполняется асинхронно: пользователь загружает изображения, а система обрабатывает их по мере доступности вычислительных ресурсов.

## Модель данных

В процессе анализа была выявлена относительная простота модели данных и отсутствие необходимости выполнять сложные запросы к ней.
Соответственно было принято решение использовать для хранения данных системы документоорентированную БД.

![Diagram](./4.design.dm.jpg)

### Дополнительные ограничения

1. Каждое изображение может находиться в одном из трёх состояний: pending, processing, processed.
```
forall
  i, s
(
  Image(i) ∧ status(i, s)
)
->
(
  s = "PENDING"
  ∨
  s = "PROCESSING"
  ∨
  s = "PROCESSED"
)
```
2. Каждое обработанное изображение должно иметь значение для каждой характеристики.
```
forall
  i, a, s
(
  Image(i) ∧ Attribute(a) ∧ status(i, "PROCESSED") ∧ name(a, s)
)
->
(
  exists
    av
  (
    attribute_values(i, av) ∧ av[s] != null
  )
)
```

## RESTful API

* Получить список характеристик и их возможные значения.
    * Request
        * URL: `/attributes`
        * Method: `GET`
    * Response
        * Success
            * Code: 200
            * Content-Type: `application/json`
            * Body:
            ```
            [
              {
                "name": string,
                "values": [
                  string,
                  ...
                ]
              },
              ...
            ]
            ```
        * Failure
            * Code: 500
            * Content-Type: `application/json`
            * Body:
            ```
            {
              "message": string
            }
            ```
* Загрузить изображение.
    * Request
        * URL: `/images`
        * Method: `POST`
        * Content-Type: `image/<type>` | `application/zip`
        * Body:
    * Response
        * Success
            * Code: 201
            * Content-Type: `application/json`
            * Body:
            ```
            [
              {
                "id": string
              },
              ...
            ]
            ```
        * Failure
            * Bad Input
                * Code: 400
                * Content-Type: `application/json`
                * Body:
                ```
                {
                  "message": string
                }
                ```
            * Internal Server Error
                * Code: 500
                * Content-Type: `application/json`
                * Body:
                ```
                {
                  "message": string
                }
                ```
* Запросить изображения, соответствующие заданным критериям.
    * Request
        * URL: `/images`
        * Method: `GET`
        * Query:
            * `attribute1=value1`
            * ...
    * Response
        * Success
            * Code: 200
            * Content-Type: `application/json`
            * Body:
            ```
            [
              {
                "id": string,
                "attribute_values": {
                  "attribute1": "value1",
                  ...
                }
              },
              ...
            ]
            ```
        * Failure
            * Bad Request
                * Code: 400
                * Content-Type: `application/json`
                * Body:
                ```
                {
                  "message": string
                }
                ```
            * Internal Server Error
                * Code: 500
                * Content-Type: `application/json`
                * Body:
                ```
                {
                  "message": string
                }
                ```
* Запросить изображение по его идентификатору.
    * Request
        * URL: `/images/<id>`
        * Method: `GET`
    * Response
        * Success
            * Code: 200
            * Content-Type: `image/<type>`
        * Failure
            * Not Found
                * Code: 404
                * Content-Type: `application/json`
                ```
                {
                  "message": string
                }
                ```
            * Internal Server Error
                * Code: 500
                * Content-Type: `application/json`
                * Body:
                ```
                {
                  "message": string
                }
                ```
* Запросить текущее состояние системы.
    * Request
        * URL: `/status`
        * Method: `GET`
    * Response
        * Success
            * Code: 200
            * Content-Type: `application/json`
            * Body:
            ```
            {
              "images": {
                "pending": number,
                "processing": number,
                "processed": number
              },
              "time": {
                "total": number,
                "avg": number
              }
            }
            ```
        * Failure
            * Internal Server Error
                * Code: 500
                * Content-Type: `application/json`
                * Body:
                ```
                {
                  "message": string
                }
                ```

## Пользовательский интерфейс

### Загрузка изображений

![Upload](./4.design.ui.upload.png)

### Поиск изображений

![Query](./4.design.ui.query.png)

### Состояние системы

![Status](./4.design.ui.status.png)

## Диаграмма классов

![Diagram](./4.design.cd.jpg)

### `API`

Методы этого класса реализуют RESTful API.

### `Worker`

Метод `run()` этого класса представляет собой бесконечный цикл, в котором проверяется наличие изображений co статусом `PENDING` в БД и выполняется их обработка. На время обработки статус изображения в БД меняется на `PROCESSING`. Обработка выполняется используя модель распознавания - экземпляр класса наследника `Model`. Конкретная модель распознавания выбирается на этапе конфигурации системы.
После обработки значения характеристик сохраняются в БД и статус изображения меняется на `PROCESSED`.

В системе может быть несколько экзепляров `Worker`, их количество определяется в зависимости от доступных вычислительных ресурсов.

### `Model`

Абстрактный класс, определяющий интерфейс, который должен быть реализован конкретными моделями распознавания.

Его наследники должны реализовать метод `process()` который берёт на вход изображение и возвращает значения для каждой характеристики.

### `RandomModel`

Эта реализация абстрактного класса `Model` реализует случайный выбор значения характеристики из множества возможных значений. Он предназначен для тестирования работы пользовательского интерфейса и API.

### `RealModel`

Эта реализация абстрактного класса `Model` реализует настоящую модель для распознавания (см. ниже).

## Модель для распознавания

### Определение объектов (человек, собака, животное)
Определение объектов делается с помощью 2х моделей доступных в библиотеке ImageAI.
- RetinaNet
- Yolo V3

Для всех объектов подобраны лучшие вероятности и лучшие лейблы. Исследование лейблов было необходимо, потому что на плохом качестве изображения модель часто путает собак с другими животными (например, овцами, коровами), которые редко встречаются на улицах города.

### Определение цвета собаки

#### Требование
Необходимо определить цвет собаки: темная, светлая, разноцветная.

#### Описание выбранного решения
Для определения доминирующего цвета был выбран алгоритм k-средних.

#### Дизайн решения
1. На изображении предварительно распознается один или несколько объектов "собака".
2. Для каждого объекта определяется, темный он или светлый.
   * Если темных объектов больше, то собака на первоначальном изображении - темного цвета.
   * Если больше светлых объектов, то собака на первоначальном изображении - светлого цвета.
   * Если темных и светлых объектов поровну, то собака на первоначальном изображении - разноцветная.

  **_Алгоритм определения цвета объекта (темный или светлый)_**
  1. У изображения обрезаются края.
  2. Методом k-средних вычисляется доминирующий цвет (в модели RGB) и яркость (0,299 R + 0,587 G + 0,114 B). 
  3. Полученная яркость сравнивается с коэффициентом 0.73:
     * Если яркость меньше 0.73, то объект "светлый".
     * Если яркость больше или равна 0.73, то объект "темный".

  Значение коэффициента, равное 0.73, выбрано, как дающее наилучшее качество определения цвета на предоставленном датасете.

### Определение длины хвоста

Делается в 2 шага:
- определение породы: реализовано с помощью нейронной сети обученной на датасете пород
- определение длины хвоста по породе: определение делается по словарю соответствия порода-длина хвоста. Словарь был создан специально в рамках проекта

### Модель для распознавания текста на изображении

#### Требование
Необходимо распознавать адрес и название камеры по фотографии

#### Описание выбранной модели
Была выбрана open source модель Tesseract OCR

#### Ограничение модели
Модель обрабатывает только текст подписи на черном фоне, данные на кадре не обрабатываются  

### Дизайн модели
Картинка переводится в черно-белый формат, далее инвертируется.  
Модель ищет черный текст на белом фоне, настроен поиск для двух языков - русского и английского.  
В ответе возвращаются первые три строки текста - номер камеры и адрес.
